# DesCert example

If you have not set up Docker on your computer yet, follow Docker's instructions to install Docker:
https://docs.docker.com/get-docker/


The idea is to create a Docker image that has this project and 
executes Daikon as part of the project's build process.

Currently, this project applies only the `daikon-gradle-plugin`.
Unfortunately, we've not been able to produce any Daikon output.

Once we are able to generate this output, we will build this project
using Circle-CI's workflows.

Below are a few scenarios I've tried in order to produce the DesCert
Docker image.

# Failed scenarios

## Using amazoncorretto:8-alpine-full Docker image

### Steps

1. Build Docker image

```sh
› docker build -t descert/descert-example-amzn -f docker/Dockerfile .
```

2. Run it

```sh
› docker run --rm -it descert-example-amzn /bin/bash
# ./gradlew daikonRun --debug
```

3. Error

```sh
# Writing decl file to ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
#
# transform on java/nio/file/StandardOpenOption, loader: null
# Skipping in_shutdown class java/nio/file/StandardOpenOption
#
# transform on java/nio/file/attribute/FileAttribute, loader: null
# Skipping in_shutdown class java/nio/file/attribute/FileAttribute
#
# transform on sun/nio/fs/UnixFileModeAttribute, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixFileModeAttribute
#
# transform on sun/nio/fs/UnixChannelFactory, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory
#
# transform on sun/nio/fs/UnixChannelFactory$Flags, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory$Flags
#
# transform on sun/nio/fs/UnixChannelFactory$1, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory$1
#
# transform on java/lang/Throwable$WrappedPrintStream, loader: null
# Skipping in_shutdown class java/lang/Throwable$WrappedPrintStream
#
# transform on java/lang/Throwable$PrintStreamOrWriter, loader: null
# Skipping in_shutdown class java/lang/Throwable$PrintStreamOrWriter
# Exception in thread "Thread-0" java.lang.Error: Can't open ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
# 	at daikon.dcomp.Premain.open(Premain.java:465)
# 	at daikon.dcomp.Premain$ShutdownThread.run(Premain.java:436)
# Caused by: java.nio.file.NoSuchFileException: ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
# 	at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
# 	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
# 	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
# 	at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214)
# 	at java.nio.file.spi.FileSystemProvider.newOutputStream(FileSystemProvider.java:434)
# 	at java.nio.file.Files.newOutputStream(Files.java:216)
# 	at java.nio.file.Files.newBufferedWriter(Files.java:2860)
# 	at daikon.dcomp.Premain.open(Premain.java:460)
# 	... 1 more
# FYI Working directory: /usr/local/src/descert-example/build/classes/java/test/com/foo
```

**Additional details can be found at the `amazoncorretto:8-alpine-full` issue.**


## Using either gradle:6.7.1-jdk8-hotspot or openjdk:8 Docker image

### Steps

1. Build Docker image

```sh
› docker build -t descert/descert-example-gradle -f docker/Dockerfile .
```
2. Run it

```sh
› docker run --rm -it descert/descert-example-gradle /bin/bash
# ./gradlew daikonRun --debug
```

3. Error
The previous command will produce the following error message,
when executing `daikon.DynComp`

```sh
Error occurred during initialization of VM
java.lang.UnsatisfiedLinkError: sun.misc.Unsafe.isBigEndian0()Z
	at sun.misc.Unsafe.isBigEndian0(Native Method)
	at sun.misc.Unsafe.<clinit>(Unsafe.java:1233)
	at sun.misc.SharedSecrets.<clinit>(SharedSecrets.java:48)
	at java.lang.ref.Reference.<clinit>(Reference.java:235)
```

**`daikon.DynComp` verbose mode did not produce any meaningful information.**


## Using cimg/openjdk:8.0.272 Docker image

Make sure you update the docker/Dockerfile's content with 
the content of 

### Steps

1. Build Docker image

```sh
› docker build -t descert/descert-example-cimg -f docker/Dockerfile .
```


2. Run it

```sh
› docker run --rm -it descert/descert-example-cimg /bin/bash
```

3. Error

Fails when executing the `./gradlew clean` task:

```sh
Gradle could not start your build.
> Could not create service of type CrossBuildFileHashCache using BuildSessionServices.createCrossBuildFileHashCache().
   > Failed to create parent directory '/usr/local/src/descert-example/.gradle' when creating directory '/usr/local/src/descert-example/.gradle/6.7.1/fileHashes'
```

## Using gehighassurance/rack-box:v3.02 Docker image


1. Build Docker image

```sh
› docker build -t descert/descert-example-rack -f docker/Dockerfile .
```


2. Run it

```sh
› docker run --rm -it --memory="8g" descert/descert-example-rack /bin/sh
```

3. Error

Very slow. It eventually crashed due to out of memory errors.




FROM amazoncorretto:8-alpine-full

# install basics
RUN apk update && apk upgrade && \
    apk add --no-cache bash git vim

# Daikon plugin has been published to gradle plugin portal
# so there is no need for the following two lines
# RUN cd ~ ; git clone https://github.com/SRI-CSL/daikon-gradle-plugin.git dgp
# RUN cd ~/dgp ; ./gradlew clean; ./gradlew build; ./gradlew publishToMavenLocal


COPY . /usr/local/src/descert-example
WORKDIR /usr/local/src/descert-example

RUN ./gradlew clean
RUN ./gradlew build
# RUN ./gradlew runDaikon

# Status
# command daikon.DynComp --output_dir=../../../../../daikon-output \
#  	--ppt-select-pattern=com.foo.AutoGeneratedTestDriver \
#   --ppt-select-pattern=com.foo.FooStuffTest com.foo.AutoGeneratedTestDriver
# throws the following error:
# Writing decl file to ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
#
# transform on java/nio/file/StandardOpenOption, loader: null
# Skipping in_shutdown class java/nio/file/StandardOpenOption
#
# transform on java/nio/file/attribute/FileAttribute, loader: null
# Skipping in_shutdown class java/nio/file/attribute/FileAttribute
#
# transform on sun/nio/fs/UnixFileModeAttribute, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixFileModeAttribute
#
# transform on sun/nio/fs/UnixChannelFactory, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory
#
# transform on sun/nio/fs/UnixChannelFactory$Flags, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory$Flags
#
# transform on sun/nio/fs/UnixChannelFactory$1, loader: null
# Skipping in_shutdown class sun/nio/fs/UnixChannelFactory$1
#
# transform on java/lang/Throwable$WrappedPrintStream, loader: null
# Skipping in_shutdown class java/lang/Throwable$WrappedPrintStream
#
# transform on java/lang/Throwable$PrintStreamOrWriter, loader: null
# Skipping in_shutdown class java/lang/Throwable$PrintStreamOrWriter
# Exception in thread "Thread-0" java.lang.Error: Can't open ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
# 	at daikon.dcomp.Premain.open(Premain.java:465)
# 	at daikon.dcomp.Premain$ShutdownThread.run(Premain.java:436)
# Caused by: java.nio.file.NoSuchFileException: ../../../../../daikon-output/AutoGeneratedTestDriver.decls-DynComp
# 	at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)
# 	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)
# 	at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)
# 	at sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:214)
# 	at java.nio.file.spi.FileSystemProvider.newOutputStream(FileSystemProvider.java:434)
# 	at java.nio.file.Files.newOutputStream(Files.java:216)
# 	at java.nio.file.Files.newBufferedWriter(Files.java:2860)
# 	at daikon.dcomp.Premain.open(Premain.java:460)
# 	... 1 more
# FYI Working directory: /usr/local/src/descert-example/build/classes/java/test/com/foo

# additional-config (old; dont use)
# RUN mkdir -p /opt/src
# WORKDIR /opt/src
# WORKDIR /usr/local/src/descert-example
# RUN ./gradlew daikonRun --stacktrace

# ENTRYPOINT ["./gradlew", "daikonRun"]